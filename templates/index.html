<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Ảnh Báo Cáo</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <h2>Upload Ảnh Báo Cáo</h2>
        <form id="uploadForm" enctype="multipart/form-data" aria-label="Form upload ảnh">
            <select id="ftpAccount" name="ftpAccount" aria-label="Tài khoản FTP" required>
                <option value="" disabled selected>Chọn tài khoản FTP</option>
                <option value="1">BN_LTT - Bắc Ninh</option>
                <option value="2">HN_NVL - Sài Đồng</option>
                <option value="3">HN_NVC - Long Biên</option>
            </select>
            <select id="reportType" name="reportType" aria-label="Loại báo cáo" required>
                <option value="" disabled selected>Chọn loại báo cáo</option>
                <option value="BCDongMoCua">Báo Cáo Biên Bản Đóng Mở Cửa</option>
                <option value="BaoCaoGiaoBan">Báo Cáo Giao Ban</option>
                <option value="ThayDoiGia">Báo Cáo Thay Đổi Giá</option>
                <option value="BatTatMatTien">Báo Cáo Bật Tắt Mặt Tiền</option>
                <option value="BCDaoTao">Báo Cáo Đào Tạo</option>
                <option value="Custom">Bổ Sung Báo Cáo Khác</option>
            </select>
            <input type="text" id="customName" name="customName" placeholder="Nhập tên file (nếu chọn 'Khác')" style="display:none" aria-label="Tên file tùy chỉnh">
            <div class="drop-zone" id="dropZone" aria-label="Kéo thả ảnh vào đây">
                Kéo thả tối đa 5 ảnh hoặc nhấn để chọn
                <input type="file" id="images" name="images[]" accept="image/jpeg,image/png,image/gif" multiple style="display:none" aria-hidden="true">
            </div>
            <div class="preview-container" id="previewContainer"></div>
            <button type="submit" id="uploadButton">Upload</button>
            <button type="button" id="cancelButton" style="display:none">Hủy</button>
            <progress id="progress" value="0" max="100" style="display:none" aria-label="Thanh tiến trình upload"></progress>
            <div id="progress-info"></div>
            <div id="file-progress" aria-live="polite"></div>
            <div id="result" aria-live="polite"></div>
        </form>
    </div>
    <div class="popup" id="successPopup" role="dialog" aria-labelledby="successPopupTitle">
        <h3 id="successPopupTitle">Upload Thành Công!</h3>
        <p id="successMessage"></p>
        <button onclick="closePopup()">OK</button>
    </div>

    <script>
        const CONFIG = {
            MAX_FILE_SIZE: 10 * 1024 * 1024,
            MAX_FILES: 5,
            ALLOWED_TYPES: ['image/jpeg', 'image/png', 'image/gif']
        };

        const state = { isUploading: false, abortController: null };
        const elements = {
            form: document.getElementById('uploadForm'),
            ftpAccount: document.getElementById('ftpAccount'),
            reportType: document.getElementById('reportType'),
            customName: document.getElementById('customName'),
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('images'),
            previewContainer: document.getElementById('previewContainer'),
            uploadButton: document.getElementById('uploadButton'),
            cancelButton: document.getElementById('cancelButton'),
            progress: document.getElementById('progress'),
            progressInfo: document.getElementById('progress-info'),
            fileProgress: document.getElementById('file-progress'),
            result: document.getElementById('result'),
            successPopup: document.getElementById('successPopup'),
            successMessage: document.getElementById('successMessage')
        };

        function sanitizeFileName(name) {
            return name.replace(/[^a-zA-Z0-9]/g, '').slice(0, 50);
        }

        function showError(message) {
            elements.result.classList.add('error');
            elements.result.textContent = `Lỗi: ${message}`;
            elements.fileProgress.textContent = '';
        }

        function clearError() {
            elements.result.classList.remove('error');
            elements.result.textContent = '';
        }

        function updateUI(uploading) {
            state.isUploading = uploading;
            elements.uploadButton.disabled = uploading;
            elements.uploadButton.textContent = uploading ? 'Đang upload...' : 'Upload';
            elements.cancelButton.style.display = uploading ? 'inline-block' : 'none';
            elements.progress.style.display = uploading ? 'block' : 'none';
            elements.progressInfo.textContent = uploading ? 'Đang xử lý...' : '';
            if (!uploading) {
                elements.fileProgress.textContent = '';
                elements.progress.value = 0;
            }
        }

        elements.reportType.addEventListener('change', () => {
            elements.customName.style.display = elements.reportType.value === 'Custom' ? 'block' : 'none';
            elements.customName.value = '';
            if (elements.customName.style.display === 'block') {
                elements.customName.focus();
            }
        });

        elements.dropZone.addEventListener('click', () => {
            if (!state.isUploading) elements.fileInput.click();
        });

        elements.dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (!state.isUploading) elements.dropZone.classList.add('dragover');
        });

        elements.dropZone.addEventListener('dragleave', () => {
            elements.dropZone.classList.remove('dragover');
        });

        elements.dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.dropZone.classList.remove('dragover');
            if (!state.isUploading) {
                elements.fileInput.files = e.dataTransfer.files;
                previewImages();
            }
        });

        elements.fileInput.addEventListener('change', previewImages);

        elements.cancelButton.addEventListener('click', () => {
            if (state.abortController) {
                state.abortController.abort();
                updateUI(false);
                showError('Upload đã bị hủy');
            }
        });

        function previewImages() {
            const files = Array.from(elements.fileInput.files).slice(0, CONFIG.MAX_FILES);
            elements.previewContainer.innerHTML = '';
            clearError();

            if (elements.fileInput.files.length > CONFIG.MAX_FILES) {
                showError(`Chỉ được chọn tối đa ${CONFIG.MAX_FILES} ảnh!`);
                elements.fileInput.value = '';
                return;
            }

            for (const file of files) {
                if (!CONFIG.ALLOWED_TYPES.includes(file.type)) {
                    showError(`File ${file.name} không phải ảnh hợp lệ (chỉ chấp nhận JPEG, PNG, GIF)!`);
                    continue;
                }
                if (file.size > CONFIG.MAX_FILE_SIZE) {
                    showError(`File ${file.name} vượt quá 10MB!`);
                    continue;
                }

                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'preview';
                img.alt = `Xem trước ${file.name}`;
                img.onerror = () => showError(`Không thể hiển thị ảnh ${file.name}`);
                elements.previewContainer.appendChild(img);
            }
        }

        elements.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();

            if (!elements.ftpAccount.value) {
                showError('Vui lòng chọn tài khoản FTP!');
                return;
            }
            if (!elements.reportType.value) {
                showError('Vui lòng chọn loại báo cáo!');
                return;
            }
            if (elements.reportType.value === 'Custom' && !elements.customName.value.trim()) {
                showError('Vui lòng nhập tên file cho báo cáo tùy chỉnh!');
                elements.customName.focus();
                return;
            }

            const files = Array.from(elements.fileInput.files).slice(0, CONFIG.MAX_FILES);
            if (files.length === 0) {
                showError('Vui lòng chọn ít nhất một ảnh!');
                return;
            }

            updateUI(true);
            state.abortController = new AbortController();
            const formData = new FormData();
            formData.append('ftpAccount', elements.ftpAccount.value);
            formData.append('reportType', elements.reportType.value);
            formData.append('customName', sanitizeFileName(elements.customName.value));

            for (const file of files) {
                formData.append('images[]', file);
            }

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                    signal: state.abortController.signal
                });

                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'Lỗi server không xác định');
                    console.error('Fetch error:', response.status, errorText);
                    throw new Error(`Lỗi server: ${response.status} - ${errorText}`);
                }

                const json = await response.json();
                if (json.success) {
                    showPopup(json.message);
                    if (json.files) {
                        json.files.forEach(file => {
                            elements.fileProgress.textContent += `Đã upload: ${file}\n`;
                        });
                    }
                    elements.progress.value = 100;
                    elements.progressInfo.textContent = 'Hoàn tất!';
                } else {
                    showError(json.message);
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    showError(error.message);
                }
            } finally {
                updateUI(false);
                state.abortController = null;
            }
        });

        function showPopup(message) {
            elements.successMessage.textContent = message;
            elements.successPopup.style.display = 'block';
        }

        function closePopup() {
            elements.successPopup.style.display = 'none';
            elements.form.reset();
            elements.previewContainer.innerHTML = '';
            clearError();
            elements.customName.style.display = 'none';
            elements.progress.style.display = 'none';
            elements.progressInfo.textContent = '';
            elements.fileProgress.textContent = '';
            elements.ftpAccount.value = '';
            elements.reportType.value = '';
        }
    </script>
</body>
</html>
