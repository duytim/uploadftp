<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload ·∫¢nh B√°o C√°o</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <h2>Upload ·∫¢nh B√°o C√°o</h2>
        <form id="uploadForm" enctype="multipart/form-data" aria-label="Form upload ·∫£nh">
            <select id="ftpAccount" name="ftpAccount" aria-label="T√†i kho·∫£n FTP" required>
                <option value="" disabled selected>Ch·ªçn t√†i kho·∫£n FTP</option>
                <option value="1">BN_LTT - B·∫Øc Ninh</option>
                <option value="2">HN_NVL - S√†i ƒê·ªìng</option>
                <option value="3">HN_NVC - Long Bi√™n</option>
            </select>
            <select id="reportType" name="reportType" aria-label="Lo·∫°i b√°o c√°o" required>
                <option value="" disabled selected>Ch·ªçn lo·∫°i b√°o c√°o</option>
                <option value="BCDongMoCua">B√°o C√°o Bi√™n B·∫£n ƒê√≥ng M·ªü C·ª≠a</option>
                <option value="BaoCaoGiaoBan">B√°o C√°o Giao Ban</option>
                <option value="ThayDoiGia">B√°o C√°o Thay ƒê·ªïi Gi√°</option>
                <option value="BatTatMatTien">B√°o C√°o B·∫≠t T·∫Øt M·∫∑t Ti·ªÅn</option>
                <option value="BCDaoTao">B√°o C√°o ƒê√†o T·∫°o</option>
                <option value="Custom">B·ªï Sung B√°o C√°o Kh√°c</option>
            </select>
            <input type="text" id="customName" name="customName" placeholder="Nh·∫≠p t√™n file (n·∫øu ch·ªçn 'Kh√°c')" style="display:none" aria-label="T√™n file t√πy ch·ªânh">
            <div class="drop-zone" id="dropZone" aria-label="K√©o th·∫£ ·∫£nh v√†o ƒë√¢y">
                K√©o th·∫£ t·ªëi ƒëa 5 ·∫£nh ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn
                <input type="file" id="images" name="images[]" accept="image/jpeg,image/png,image/gif" multiple style="display:none" aria-hidden="true">
            </div>
            <div class="preview-container" id="previewContainer"></div>
            <button type="submit" id="uploadButton">Upload</button>
            <button type="button" id="historyMenu">L·ªãch s·ª≠</button>
            <button type="button" id="cancelButton" style="display:none">H·ªßy</button>
            <progress id="progress" value="0" max="100" style="display:none" aria-label="Thanh ti·∫øn tr√¨nh upload"></progress>
            <div id="progress-info"></div>
            <div id="file-progress" aria-live="polite"></div>
            <div id="result" aria-live="polite"></div>
        </form>
        <div class="theme-toggle-container">
            <button id="themeToggle" aria-label="Chuy·ªÉn ƒë·ªïi giao di·ªán">
                <span class="theme-icon">üåô</span>
            </button>
        </div>
    </div>
    <div class="popup" id="successPopup" role="dialog" aria-labelledby="successPopupTitle">
        <h3 id="successPopupTitle">Upload Th√†nh C√¥ng!</h3>
        <p id="successMessage"></p>
        <button onclick="closePopup()">OK</button>
    </div>
    <div class="popup" id="historyPopup" role="dialog" aria-labelledby="historyPopupTitle">
        <h3 id="historyPopupTitle">L·ªãch s·ª≠ file ƒë√£ upload</h3>
        <select id="ftpAccountHistory" name="ftpAccountHistory" aria-label="T√†i kho·∫£n FTP" required>
            <option value="" disabled selected>Ch·ªçn t√†i kho·∫£n FTP</option>
            <option value="1">BN_LTT - B·∫Øc Ninh</option>
            <option value="2">HN_NVL - S√†i ƒê·ªìng</option>
            <option value="3">HN_NVC - Long Bi√™n</option>
        </select>
        <input type="date" id="historyDate" aria-label="Ch·ªçn ng√†y">
        <button id="fetchHistory">T√¨m ki·∫øm</button>
        <div id="historyTable"></div>
        <button onclick="closeHistoryPopup()">ƒê√≥ng</button>
    </div>

    <!-- Rest of the JavaScript remains the same with these modifications -->
    <script>
        // ... Previous JavaScript code ...
        
        // Modified previewImages function
        function previewImages() {
            const files = Array.from(elements.fileInput.files).slice(0, CONFIG.MAX_FILES);
            elements.previewContainer.innerHTML = '';
            clearError();
    
            if (elements.fileInput.files.length > CONFIG.MAX_FILES) {
                showError(`Ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa ${CONFIG.MAX_FILES} ·∫£nh!`);
                elements.fileInput.value = '';
                return;
            }
    
            const fileList = new DataTransfer();
            for (const file of files) {
                if (!CONFIG.ALLOWED_TYPES.includes(file.type)) {
                    showError(`File ${file.name} kh√¥ng ph·∫£i ·∫£nh h·ª£p l·ªá (ch·ªâ ch·∫•p nh·∫≠n JPEG, PNG, GIF)!`);
                    continue;
                }
                if (file.size > CONFIG.MAX_FILE_SIZE) {
                    showError(`File ${file.name} v∆∞·ª£t qu√° 10MB!`);
                    continue;
                }
    
                const container = document.createElement('div');
                container.className = 'preview-item';
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'preview';
                img.alt = `Xem tr∆∞·ªõc ${file.name}`;
                img.onerror = () => showError(`Kh√¥ng th·ªÉ hi·ªÉn th·ªã ·∫£nh ${file.name}`);
                img.onclick = () => {
                    // Remove zoomed class from all other images
                    document.querySelectorAll('.preview.zoomed').forEach(otherImg => {
                        if (otherImg !== img) {
                            otherImg.classList.remove('zoomed');
                            otherImg.classList.add('minimized');
                        }
                    });
                    img.classList.toggle('zoomed');
                    if (!img.classList.contains('zoomed')) {
                        document.querySelectorAll('.preview.minimized').forEach(otherImg => {
                            otherImg.classList.remove('minimized');
                        });
                    }
                };
    
                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '&times;';
                removeBtn.className = 'remove-preview';
                removeBtn.onclick = () => {
                    container.remove();
                    const newFiles = Array.from(elements.fileInput.files).filter(f => f !== file);
                    newFiles.forEach(f => fileList.items.add(f));
                    elements.fileInput.files = fileList.files;
                };
    
                container.appendChild(img);
                container.appendChild(removeBtn);
                elements.previewContainer.appendChild(container);
                fileList.items.add(file);
            }
            elements.fileInput.files = fileList.files;
        }

        // Modified displayHistoryByDate function
        async function displayHistoryByDate() {
            const date = document.getElementById('historyDate').value;
            const ftpAccount = document.getElementById('ftpAccountHistory').value;
            const historyTable = document.getElementById('historyTable');
    
            if (!ftpAccount) {
                historyTable.innerHTML = '<p class="error">Vui l√≤ng ch·ªçn t√†i kho·∫£n FTP tr∆∞·ªõc!</p>';
                return;
            }
            if (!date) {
                historyTable.innerHTML = '<p class="error">Vui l√≤ng ch·ªçn ng√†y!</p>';
                return;
            }
    
            try {
                const formData = new FormData();
                formData.append('ftpAccount', ftpAccount);
                formData.append('date', date);
                const response = await fetch('/list_files_by_date', {
                    method: 'POST',
                    body: formData
                });
                const json = await response.json();
                if (json.success) {
                    historyTable.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>T√™n file</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${json.files.map(file => `
                                        <tr>
                                            <td>${file}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    historyTable.innerHTML = `<p class="error">${json.message}</p>`;
                }
            } catch (error) {
                historyTable.innerHTML = `<p class="error">L·ªói khi t·∫£i danh s√°ch file: ${error.message}</p>`;
            }
        }

        // Modified toggleTheme function
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.querySelector('.theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        // Rest of the JavaScript code remains the same
    </script>
</body>
</html>
