<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload ·∫¢nh B√°o C√°o</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <h2>Upload ·∫¢nh B√°o C√°o</h2>
        <form id="uploadForm" enctype="multipart/form-data" aria-label="Form upload ·∫£nh">
            <select id="ftpAccount" name="ftpAccount" aria-label="T√†i kho·∫£n FTP" required>
                <option value="" disabled selected>Ch·ªçn t√†i kho·∫£n FTP</option>
                <option value="1">BN_LTT - B·∫Øc Ninh</option>
                <option value="2">HN_NVL - S√†i ƒê·ªìng</option>
                <option value="3">HN_NVC - Long Bi√™n</option>
            </select>
            <select id="reportType" name="reportType" aria-label="Lo·∫°i b√°o c√°o" required>
                <option value="" disabled selected>Ch·ªçn lo·∫°i b√°o c√°o</option>
                <option value="BCDongMoCua">B√°o C√°o Bi√™n B·∫£n ƒê√≥ng M·ªü C·ª≠a</option>
                <option value="BaoCaoGiaoBan">B√°o C√°o Giao Ban</option>
                <option value="ThayDoiGia">B√°o C√°o Thay ƒê·ªïi Gi√°</option>
                <option value="BatTatMatTien">B√°o C√°o B·∫≠t T·∫Øt M·∫∑t Ti·ªÅn</option>
                <option value="BCDaoTao">B√°o C√°o ƒê√†o T·∫°o</option>
                <option value="Custom">B·ªï Sung B√°o C√°o Kh√°c</option>
            </select>
            <input type="text" id="customName" name="customName" placeholder="Nh·∫≠p t√™n file (n·∫øu ch·ªçn 'Kh√°c')" style="display:none" aria-label="T√™n file t√πy ch·ªânh">
            <div class="drop-zone" id="dropZone" aria-label="K√©o th·∫£ ·∫£nh v√†o ƒë√¢y">
                K√©o th·∫£ t·ªëi ƒëa 5 ·∫£nh ho·∫∑c nh·∫•n ƒë·ªÉ ch·ªçn
                <input type="file" id="images" name="images[]" accept="image/jpeg,image/png,image/gif" multiple style="display:none" aria-hidden="true">
            </div>
            <div class="preview-container" id="previewContainer"></div>
            <button type="submit" id="uploadButton">Upload</button>
            <button type="button" id="historyMenu">L·ªãch s·ª≠</button>
            <button type="button" id="cancelButton" style="display:none">H·ªßy</button>
            <progress id="progress" value="0" max="100" style="display:none" aria-label="Thanh ti·∫øn tr√¨nh upload"></progress>
            <div id="progress-info"></div>
            <div id="file-progress" aria-live="polite"></div>
            <div id="result" aria-live="polite"></div>
        </form>
        <div class="theme-toggle-container">
            <button id="themeToggle" aria-label="Chuy·ªÉn ƒë·ªïi giao di·ªán">
                <span class="theme-icon">üåô</span>
            </button>
        </div>
    </div>
    <div class="popup" id="successPopup" role="dialog" aria-labelledby="successPopupTitle">
        <h3 id="successPopupTitle">Upload Th√†nh C√¥ng!</h3>
        <p id="successMessage"></p>
        <button onclick="closePopup()">OK</button>
    </div>
    <div class="popup" id="historyPopup" role="dialog" aria-labelledby="historyPopupTitle">
        <h3 id="historyPopupTitle">L·ªãch s·ª≠ file ƒë√£ upload</h3>
        <select id="ftpAccountHistory" name="ftpAccountHistory" aria-label="T√†i kho·∫£n FTP" required>
            <option value="" disabled selected>Ch·ªçn t√†i kho·∫£n FTP</option>
            <option value="1">BN_LTT - B·∫Øc Ninh</option>
            <option value="2">HN_NVL - S√†i ƒê·ªìng</option>
            <option value="3">HN_NVC - Long Bi√™n</option>
        </select>
        <input type="date" id="historyDate" aria-label="Ch·ªçn ng√†y">
        <button id="fetchHistory">T√¨m ki·∫øm</button>
        <div id="historyTable"></div>
        <button onclick="closeHistoryPopup()">ƒê√≥ng</button>
    </div>

    <script>
        const CONFIG = {
            MAX_FILE_SIZE: 10 * 1024 * 1024,
            MAX_FILES: 5,
            ALLOWED_TYPES: ['image/jpeg', 'image/png', 'image/gif']
        };

        const state = { isUploading: false, abortController: null };
        const elements = {
            form: document.getElementById('uploadForm'),
            ftpAccount: document.getElementById('ftpAccount'),
            reportType: document.getElementById('reportType'),
            customName: document.getElementById('customName'),
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('images'),
            previewContainer: document.getElementById('previewContainer'),
            uploadButton: document.getElementById('uploadButton'),
            cancelButton: document.getElementById('cancelButton'),
            progress: document.getElementById('progress'),
            progressInfo: document.getElementById('progress-info'),
            fileProgress: document.getElementById('file-progress'),
            result: document.getElementById('result'),
            successPopup: document.getElementById('successPopup'),
            successMessage: document.getElementById('successMessage')
        };

        function sanitizeFileName(name) {
            return name.replace(/[^a-zA-Z0-9]/g, '').slice(0, 50);
        }

        function showError(message) {
            elements.result.classList.add('error');
            elements.result.textContent = `L·ªói: ${message}`;
            elements.fileProgress.textContent = '';
        }

        function clearError() {
            elements.result.classList.remove('error');
            elements.result.textContent = '';
        }

        function updateUI(uploading) {
            state.isUploading = uploading;
            elements.uploadButton.disabled = uploading;
            elements.uploadButton.textContent = uploading ? 'ƒêang upload...' : 'Upload';
            elements.cancelButton.style.display = uploading ? 'inline-block' : 'none';
            elements.progress.style.display = uploading ? 'block' : 'none';
            elements.progressInfo.textContent = uploading ? 'ƒêang x·ª≠ l√Ω...' : '';
            if (!uploading) {
                elements.fileProgress.textContent = '';
                elements.progress.value = 0;
            }
        }

        elements.reportType.addEventListener('change', () => {
            elements.customName.style.display = elements.reportType.value === 'Custom' ? 'block' : 'none';
            elements.customName.value = '';
            if (elements.customName.style.display === 'block') {
                elements.customName.focus();
            }
        });

        elements.dropZone.addEventListener('click', () => {
            if (!state.isUploading) elements.fileInput.click();
        });

        elements.dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            if (!state.isUploading) elements.dropZone.classList.add('dragover');
        });

        elements.dropZone.addEventListener('dragleave', () => {
            elements.dropZone.classList.remove('dragover');
        });

        elements.dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.dropZone.classList.remove('dragover');
            if (!state.isUploading) {
                elements.fileInput.files = e.dataTransfer.files;
                previewImages();
            }
        });

        elements.fileInput.addEventListener('change', previewImages);

        elements.cancelButton.addEventListener('click', () => {
            if (state.abortController) {
                state.abortController.abort();
                updateUI(false);
                showError('Upload ƒë√£ b·ªã h·ªßy');
            }
        });

        function previewImages() {
            const files = Array.from(elements.fileInput.files).slice(0, CONFIG.MAX_FILES);
            elements.previewContainer.innerHTML = '';
            clearError();

            if (elements.fileInput.files.length > CONFIG.MAX_FILES) {
                showError(`Ch·ªâ ƒë∆∞·ª£c ch·ªçn t·ªëi ƒëa ${CONFIG.MAX_FILES} ·∫£nh!`);
                elements.fileInput.value = '';
                return;
            }

            const fileList = new DataTransfer();
            for (const file of files) {
                if (!CONFIG.ALLOWED_TYPES.includes(file.type)) {
                    showError(`File ${file.name} kh√¥ng ph·∫£i ·∫£nh h·ª£p l·ªá (ch·ªâ ch·∫•p nh·∫≠n JPEG, PNG, GIF)!`);
                    continue;
                }
                if (file.size > CONFIG.MAX_FILE_SIZE) {
                    showError(`File ${file.name} v∆∞·ª£t qu√° 10MB!`);
                    continue;
                }

                const container = document.createElement('div');
                container.className = 'preview-item';
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.className = 'preview';
                img.alt = `Xem tr∆∞·ªõc ${file.name}`;
                img.onerror = () => showError(`Kh√¥ng th·ªÉ hi·ªÉn th·ªã ·∫£nh ${file.name}`);
                img.onclick = () => {
                    document.querySelectorAll('.preview.zoomed').forEach(otherImg => {
                        if (otherImg !== img) {
                            otherImg.classList.remove('zoomed');
                            otherImg.classList.add('minimized');
                        }
                    });
                    img.classList.toggle('zoomed');
                    if (!img.classList.contains('zoomed')) {
                        document.querySelectorAll('.preview.minimized').forEach(otherImg => {
                            otherImg.classList.remove('minimized');
                        });
                    }
                };

                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '√ó';
                removeBtn.className = 'remove-preview';
                removeBtn.onclick = () => {
                    container.remove();
                    const newFiles = Array.from(elements.fileInput.files).filter(f => f !== file);
                    newFiles.forEach(f => fileList.items.add(f));
                    elements.fileInput.files = fileList.files;
                };

                container.appendChild(img);
                container.appendChild(removeBtn);
                elements.previewContainer.appendChild(container);
                fileList.items.add(file);
            }
            elements.fileInput.files = fileList.files;
        }

        elements.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearError();

            if (!elements.ftpAccount.value) {
                showError('Vui l√≤ng ch·ªçn t√†i kho·∫£n FTP!');
                return;
            }
            if (!elements.reportType.value) {
                showError('Vui l√≤ng ch·ªçn lo·∫°i b√°o c√°o!');
                return;
            }
            if (elements.reportType.value === 'Custom' && !elements.customName.value.trim()) {
                showError('Vui l√≤ng nh·∫≠p t√™n file cho b√°o c√°o t√πy ch·ªânh!');
                elements.customName.focus();
                return;
            }

            const files = Array.from(elements.fileInput.files).slice(0, CONFIG.MAX_FILES);
            if (files.length === 0) {
                showError('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt ·∫£nh!');
                return;
            }

            updateUI(true);
            state.abortController = new AbortController();
            const formData = new FormData();
            formData.append('ftpAccount', elements.ftpAccount.value);
            formData.append('reportType', elements.reportType.value);
            formData.append('customName', sanitizeFileName(elements.customName.value));

            for (const file of files) {
                formData.append('images[]', file);
            }

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                    signal: state.abortController.signal
                });

                if (!response.ok) {
                    const errorText = await response.text().catch(() => 'L·ªói server kh√¥ng x√°c ƒë·ªãnh');
                    console.error('Fetch error:', response.status, errorText);
                    throw new Error(`L·ªói server: ${response.status} - ${errorText}`);
                }

                const json = await response.json();
                if (json.success) {
                    showPopup(json.message);
                    if (json.files) {
                        json.files.forEach(file => {
                            elements.fileProgress.textContent += `ƒê√£ upload: ${file}\n`;
                        });
                    }
                    elements.progress.value = 100;
                    elements.progressInfo.textContent = 'Ho√†n t·∫•t!';
                } else {
                    showError(json.message);
                }
            } catch (error) {
                if (error.name !== 'AbortError') {
                    showError(error.message);
                }
            } finally {
                updateUI(false);
                state.abortController = null;
            }
        });

        function showPopup(message) {
            elements.successMessage.className = 'success-message';
            elements.successMessage.textContent = message;
            elements.successPopup.style.display = 'block';
            elements.successPopup.classList.add('active');
        }

        function closePopup() {
            elements.successPopup.classList.remove('active');
            elements.successPopup.style.display = 'none';
            elements.form.reset();
            elements.previewContainer.innerHTML = '';
            clearError();
            elements.customName.style.display = 'none';
            elements.progress.style.display = 'none';
            elements.progressInfo.textContent = '';
            elements.fileProgress.textContent = '';
            elements.ftpAccount.value = '';
            elements.reportType.value = '';
        }

        async function displayHistoryByDate() {
            const date = document.getElementById('historyDate').value;
            const ftpAccount = document.getElementById('ftpAccountHistory').value;
            const historyTable = document.getElementById('historyTable');

            if (!ftpAccount) {
                historyTable.innerHTML = '<p class="error">Vui l√≤ng ch·ªçn t√†i kho·∫£n FTP tr∆∞·ªõc!</p>';
                return;
            }
            if (!date) {
                historyTable.innerHTML = '<p class="error">Vui l√≤ng ch·ªçn ng√†y!</p>';
                return;
            }

            try {
                const formData = new FormData();
                formData.append('ftpAccount', ftpAccount);
                formData.append('date', date);
                const response = await fetch('/list_files_by_date', {
                    method: 'POST',
                    body: formData
                });
                const json = await response.json();
                if (json.success) {
                    historyTable.innerHTML = `
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>T√™n file</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${json.files.map(file => `
                                        <tr>
                                            <td>${file}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else {
                    historyTable.innerHTML = `<p class="error">${json.message}</p>`;
                }
            } catch (error) {
                historyTable.innerHTML = `<p class="error">L·ªói khi t·∫£i danh s√°ch file: ${error.message}</p>`;
            }
        }

        function openHistoryPopup() {
            document.getElementById('historyPopup').classList.add('active');
            document.getElementById('historyPopup').style.display = 'block';
        }

        function closeHistoryPopup() {
            document.getElementById('historyPopup').classList.remove('active');
            document.getElementById('historyPopup').style.display = 'none';
            document.getElementById('historyTable').innerHTML = '';
            document.getElementById('historyDate').value = '';
            document.getElementById('ftpAccountHistory').value = '';
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.querySelector('.theme-icon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.querySelector('.theme-icon').textContent = '‚òÄÔ∏è';
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('historyMenu').addEventListener('click', openHistoryPopup);
            document.getElementById('fetchHistory').addEventListener('click', displayHistoryByDate);
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        });
    </script>
</body>
</html>
